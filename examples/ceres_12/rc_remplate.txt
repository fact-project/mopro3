# ==========================================================================
#############################################################################
# ==========================================================================
#                              General
# ==========================================================================
#############################################################################
# ==========================================================================

# -------------------------------------------------------------------------
# Use this if you want to setup the logging stream for the jobs
# (overwrites command line options)
# -------------------------------------------------------------------------
MLog.VerbosityLevel: 0
MLog.DebugLevel:     0
MLog.NoColors:       yes

# ==========================================================================
#############################################################################
# ==========================================================================
#                                   Ceres
# ==========================================================================
#############################################################################
# ==========================================================================

# -------------------------------------------------------------------------
# Use this if you want to write the MJStar output somewhere
# If you don't want it, it is written to the calibration output anyhow.
# -------------------------------------------------------------------------
#PathOut: .
#PathIn: .


# -------------------------------------------------------------------------
# Configure Eventloop
# -------------------------------------------------------------------------
#MaxEvents: 10000
#Overwrite: yes,no


# -------------------------------------------------------------------------
# Use this to setup binnings. For more details see: MBinning::ReadEnv
# -------------------------------------------------------------------------
# BinningEnergy.Raw:      100      1    100000  log
# BinningSize.Raw:        100      1  10000000  log
BinningImpact.Raw:  40 0 1000
# BinningHeight.Raw:       50      0        12
# BinningAz.Raw:          360   -360       360
# BinningZd.Raw:           70      0        70
# BinningViewCone.Raw:    155      0        31
BinningTrigPos.Raw: 300 -25 275
# BinningEvtWidth.Raw:    150      0        25
# BinningDist.Raw:        100      0       2.5
# BinningDistC.Raw:       100      0       2.5
# BinningThreshold.Raw:    35    0.9     90000  log
# BinningEnergyEst.Raw:   100    0.9     90000  log


# -------------------------------------------------------------------------
# Initialize random number generator (see MJob::InitRandomNumberGenerator)
# -------------------------------------------------------------------------
RandomNumberGenerator: TRandom3
RandomNumberSeedValue: {{ run.id + 1 }}


# -------------------------------------------------------------------------
# Ceres general setup
# -------------------------------------------------------------------------

# Switch off the camera "electronics"
#Camera: Off

# Force the use of the "hardware" trigger for calibration data
#ForceTrigger: Yes


# -------------------------------------------------------------------------
# Here you can control the poiting of the telescope. To switch on
# off-target observations set a value for the distance !=0 [deg].
# For details see MSimPointingPos
# -------------------------------------------------------------------------
{% if settings.diffuse %}
MSimPointingPos.OffTargetDistance: -{{ settings.off_target_distance }}
{% else %}
MSimPointingPos.OffTargetDistance: {{ settings.off_target_distance }}
{% endif %}
#MSimPointingPos.OffTargetPhi: -1


# -------------------------------------------------------------------------
# Setup the reflector and camera geometry
# -------------------------------------------------------------------------
Reflector.Constructor: MReflector

# For the file definition see MReflector::ReadFile

Reflector.FileName: {resource_directory}/reflector.txt
Reflector.SetSigmaPSF: {{ settings.psf_sigma }}
MGeomCam.Constructor:   MGeomCamFACT();

#MSimBundlePhotons.FileName: resmc/fact/dwarf-fact.txt

# Set the APD type (1: 30x30 <default>, 2: 60x60, 3:60x60(ct=15%))
MSimAPD.Type:                   0
MSimAPD.NumCells:               60
MSimAPD.DeadTime:               {{ settings.apd_dead_time }}
MSimAPD.RecoveryTime:           {{ settings.apd_recovery_time }}
MSimAPD.CrosstalkCoefficient:   {{ settings.apd_cross_talk }}
MSimAPD.AfterpulseProb1:        {{ settings.apd_afterpulse_probability_1 }}
MSimAPD.AfterpulseProb2:        {{ settings.apd_afterpulse_probability_2 }}

MSimExcessNoise.ExcessNoise:    {{ settings.excess_noise }}

# -------------------------------------------------------------------------
# Setup the absorption, conversion efficiency and angular acceptance
# -------------------------------------------------------------------------
MirrorReflectivity.FileName:           {{ resource_directory }}/mirror-reflectivity.txt
PhotonDetectionEfficiency.FileName:    {{ resource_directory }}/pde.txt
ConesAngularAcceptance.FileName:       {{ resource_directory }}/cone-angular-acceptance.txt
ConesTransmission.FileName:            {{ resource_directory }}/cone-transmission.txt

AdditionalPhotonAcceptance.Function.Name:     {{ settings.additional_photon_acceptance }}
AdditionalPhotonAcceptance.Function.Npx:      100
AdditionalPhotonAcceptance.Function.Xmin:     290
AdditionalPhotonAcceptance.Function.Xmax:     900

# -------------------------------------------------------------------------
# Setup what in MMCS would be called "additional spot size"
# -------------------------------------------------------------------------
#MSimPSF.Sigma: -1
#MSimReflector.DetectorMargin: 0

# -------------------------------------------------------------------------
# Setup the dark counts (FrequencyFixed) and the NSB noise per cm^2
# -------------------------------------------------------------------------
MSimRandomPhotons.FrequencyFixed: {{ settings.dark_count_rate }}
{% if settings.nsb_rate %}
MSimRandomPhotons.FrequencyNSB: {{ run.nsb_rate }}
{% else %}
MSimRandomPhotons.FileNameNSB:  {{ resource_directory }}/nsb.txt
{% endif %}


# -------------------------------------------------------------------------
# Setup the trigger
# -------------------------------------------------------------------------
# This line could be omitted but then the discriminator would be
# evaluated for all pixels not just for the pixels which are
# later "connected" in the trigger (used in the coincidence map)
MSimTrigger.FileNameRouteAC: {{ resource_directory }}/route-ac.txt
MSimTrigger.DiscriminatorThreshold: {{ setings.discriminator_threshold }}

MSimTrigger.CableDelay: 21.0
MSimTrigger.CableDamping: -0.96
MSimTrigger.CoincidenceTime: 0.5

# Every Pixel(!) should see the same signal independant of its size
MSimCalibrationSignal.NumPhotons: 24
MSimCalibrationSignal.NumEvents:  1000

IntendedPulsePos.Val: 26

# -------------------------------------------------------------------------
# Setup the FADC
# -------------------------------------------------------------------------

MRawRunHeader.SamplingFrequency: 2000
MRawRunHeader.NumSamples:        300
MRawRunHeader.NumBytesPerSample: 2
MRawRunHeader.FadcResolution:    12

MSimCamera.DefaultOffset:       -1850.0
MSimCamera.DefaultNoise:        2.8125
MSimCamera.DefaultGain:         22.553


# Value for the fudgefactor in the calculation of the accoupling:
MSimCamera.ACFudgeFactor: 0.3136
MSimCamera.ACTimeConstant: 20


#MSimReadout.fConversionFactor: 1

# The number of sampling points is almost irrelevant because they
# are equidistant, i.e. calculated and no search is necessary.
# Nevertheless, you must make sure that there are enough points
# to sample the function accuratly enough.
# Attention: x in the function is given in slices, so if you change the sampling
# frequency you have to change also this function
PulseShape.Function.Name:  {{ settings.pulse_shape_function }}
PulseShape.Function.Npx:   310
PulseShape.Function.Xmin:  -10
PulseShape.Function.Xmax:  300


# -------------------------------------------------------------------------
# Setup an image cleaning on the pure gamma signal (without noise)
# -------------------------------------------------------------------------

#MImgCleanStd.CleanLevel1:   6.0
#MImgCleanStd.CleanLevel2:   6.0

# -------------------------------------------------------------------------
# This is a cut executed after the calculation of the image parameters
# -------------------------------------------------------------------------

#Cut.Condition: MNewImagePar.fNumUsedPixels>3 && MHillas.fSize>6
#Cut.Condition: MHillas.fSize>10
#&& MHillas.fSize>30
#MSimTrigger.SimulateElectronics: Off
Cut.Inverted: yes
Cut.Condition: MHillas.fSize>10.0


# Does not trigger anyway
#ContEmpty3.Condition: MPhotonEvent.GetNumPhotons<10
ContEmpty3.Condition: MPhotonEvent.GetNumPhotons<10

MFixTimeOffset.FileName: {{ resource_directory }}/pixel-delays.csv
ResidualTimeSpread.Val: {{ settings.residual_time_spread }}
GapdTimeJitter.Val: {{ settings.gapd_time_jitter }}

# last line comment

